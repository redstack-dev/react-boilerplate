# Формирование тест-кейсов

Формирование тест-кейсов - это не тривиальная задача. Единый формат призван упростить процесс формирования тест-кейсов.

Единый формат позволяет:

- Упростить процесс формирования тест-кейсов
- Увеличить  качество тест-кейсов, отвечая каждый раз на необходимые вопросы при формировании тест-кейсов

# Краткий обзор принципов

<https://www.youtube.com/watch?v=DmFzvrhKyxo&ab_channel=AstralFrontend>

---

# Формат

Каждый тест-кейс должен строиться по формуле:

```jsx
it('ПРЕДМЕТ_ТЕСТИРОВАНИЯ + ОЖИДАЕМЫЙ_РЕЗУЛЬТАТ + УСЛОВИЕ')
```

## Примеры

- `Общий счетчик товаров увеличивается при добавлении товаров в корзину`
- `Процесс оплаты запускается фоном при открытии модалки`
- `В результирующую строку добавляется постфикс`
- `Value "%s" невалидно, если не является строкой`
- `Дефолтный message переопределяется через параметры`
- `Контент отображается по нажатию на title`
- `Тэг блокируется при disabled=true`
- `onChange вызывается при нажатии на тэг`

### ПРЕДМЕТ_ТЕСТИРОВАНИЯ

При выборе предмета тестирования необходимо понять **ЧТО** мы собираемся проверять на какой объект (предмет) направлена проверка.

Примеры предмета тестирования:

- `Общий счетчик товаров` увеличивается при добавлении товаров в корзину
- `Процесс оплаты` запускается фоном при открытии модалки
- `В результирующую строку` добавляется постфикс
- `Value "%s"` невалидно, если не является строкой
- `Дефолтный message` переопределяется через параметры
- `Контент` отображается по нажатию на title
- `Тэг` блокируется при disabled=true
- `onChange` вызывается при нажатии на тэг

### ОЖИДАЕМЫЙ_РЕЗУЛЬТАТ

Вторая часть тест-кейса обязательно должна указывать на ожидаемый результат. Ожидаемый результат может быть действием, состоянием, побочным эффектом.

Примеры ожидаемого результат:

- Общий счетчик товаров `увеличивается` при добавлении товаров в корзину
- Процесс оплаты `запускается фоном` при открытии модалки
- В результирующую строку `добавляется постфикс`
- Value "%s" `невалидно`, если не является строкой
- Дефолтный message `переопределяется` через параметры
- Контент `отображается` по нажатию на title
- Тэг `блокируется` при disabled=true
- onChange `вызывается` при нажатии на тэг

### УСЛОВИЕ

Условие - опциональный блок.

Примеры условий:

- Общий счетчик товаров увеличивается `при добавлении товаров в корзину`
- Процесс оплаты запускается фоном `при открытии модалки`
- Value "%s" невалидно, `если не является строкой`
- Дефолтный message переопределяется `через параметры`
- Контент отображается `по нажатию на title`
- Тэг блокируется `при disabled=true`
- onChange вызывается `при нажатии на тэг`

---

# Группировка тест-кейсов

Допускается группировка тест-кейсов по **предмету тестирования и условию.**

**Пример группировки по предмету тестирования:**

```jsx
describe('Общий счетчик товаров', () => {
  it('Увеличивается при добавлении товаров до успешного выполнения запроса')

  it(
    'Откатывается в исходное при ошибке запроса на добавления товаров в корзину',
  )

  it('Уменьшается при удалении товаров до успешного выполнения запроса')

  it(
    'Откатывается в исходное при ошибке запроса на удаление товаров из корзины',
  )
})
```

**Пример группировки по условию:**

```jsx
describe('Query', () => {
  describe('При возникновении ошибки', () => {
    it('onError вызывается с текстом ошибки')

    it('Статусные флаги устанавливаются в error state')

    it('Сбрасывается data')
  })
})
```

---

# Тестирование бизнес-логики

В архитектуре бизнес-логика находится в слоях: `Data` и `Modules`.

### На основе постановки задачи

**Тест-кейсы для бизнес-логики должны  основываться на постановке задачи**, которую реализовали аналитики.

Постановка к задаче, как правило, содержит **предмет тестирования**, **ожидаемый результат** и **условие**.

**Пример**

Постановка:

```tsx
# Оплата товаров в корзине

## Основной сценарий

1. Пользователь добавил товары в корзину
2. Пользователь перешел в корзину
3. Система отображает список добавленных в корзину товаров
4. Если у пользователя сохранена карта, то по нажатию на кнопку “Оплатить”:
    1. Фоном запускается оплата товара через сохраненную карту
    2. Система отображает модальное окно для отображения статуса оплаты
5. Система перенаправляет пользователя на страницу популярных товаров

## Требование 1. Реализовать обработку ошибок оплаты

Если произошла ошибка при оплате картой, то в модальном окне должно отобразиться сообщение “Ошибка при оплате картой”.
```

Часть постановки и код, реализующий требования:

```tsx
4. Если у пользователя сохранена карта, то по нажатию на кнопку “Оплатить”:
    1. Фоном запускается оплата товара через сохраненную карту
```

```tsx
export class CartScreenStore {

...

  public openModal = () => {
    this.pay();
    this.modalStore.setTrue();
  };

...

  public pay = () => {
    if (!this.cardPaymentStore.isAllowCardPayment) {
      this.notifyService.info('Оплата картой недоступна');

      return;
    }

    this.cardPaymentStore.pay({
      onSuccess: () => {
        this.routerService.navigate('/popular');
      },
    });
  };
}
```

Тест на реализованную часть требований:

```tsx
describe('CartScreenStore', () => {
  // Название тест-кейса соответсвует тексту постановки
  it('Процесс оплаты запускается фоном при открытии модалки', () => {
    const cartPaymentStoreMock = mock<CardPaymentStore>()
    const sut = new CartScreenStore(
      cartPaymentStoreMock,
      createRouterMock(),
      createNotifyMock(),
    )

    sut.openModal()

    expect(cartPaymentStoreMock.pay).toBeCalled()
  })
})
```

### На основе приемочных тест-кейсов

Часть тест-кейсов может быть основана на приемочных кейсах, которые описали QA для задачи.

Тесты, основанные на приемочных тест-кейс более предпочтительны потому, что их создают специалисты по тестированию.

**Пример**

Приемочный тест-кейс:

```tsx
# Приемочный тест-кейс. Успешная оплата товара картой

## Подготовка

1. В личном кабинете привязать карту для оплаты
2. В разделе “Товары” добавить в корзину товары
3. В хедере нажать кнопку “Корзина”

## Шаги

## В корзине нажать кнопку “Оплатить”

**Ожидаемый результат:**

1. Отображается модальное окно с лоадером
2. После ожидания происходит редирект на страницу “Популярные товары”
```

Тест по приемочному тест-кейсу:

```tsx
describe('CartScreenStore', () => {
  it('Процесс оплаты запускается фоном при открытии модалки', () => {})
})
```

---

# Тестирование инфраструктурного кода

В  инфраструктурный код находится в слое `shared`.

Формирование тест-кейсов должно происходит на основе:

- Доступных инвариантов состояния

```jsx
it('isSuccess переключается в true после успешного выполнения запроса')
```

- Доступного поведения

```jsx
it('Контент отображается по нажатию на header')
```

- Реакции на входные параметры

```jsx
it('Контент отображается при isExpanded=true')
```

---

# Тестирование на основе массива входных значений. Использование it.each

Для проверки поведение SUT на основе массива входных данных используется `it.each`.

При использовании `it.each` условие обязательно должно присутствовать:

```jsx
it.each(['', '9', '92', '921', '92176'])(
  'Value "%s" невалидно, если длина поля не равна 4 символам'
)
```
